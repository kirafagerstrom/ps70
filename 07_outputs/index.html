<!DOCTYPE html>
<html lang="en">

<title>PS70: Intro to Digital Fabrication </title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="../style.css" rel="stylesheet">


<nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #FFFFFF; color: #053034;">
  <div style="align-items: center; justify-content: center;" class="container-fluid">
    <div class="flexrow">
      <h2 class="nav-title">ps 70: intro to digital fabrication spring 24</h2>
    </div>
    <div class="navbar-nav">
      <h4><a class="nav-link" href="./index.html" style="color: #053034;">Home</a></h4>
      <h4><a class="nav-link" href="./about.html" style="color: #053034;">About</a></h4>
      <h4><a class="nav-link" href="./13_finalproject/index.html" style="color: #053034;">Final Project</a></h4>
    </div>
  </div>
</nav>

<body>
<xmp style="display:none;">
<div class="textcontainer">
<p class="margin">   </p>
<h3>Week 7: Output Devices</h3>

<h4>Assignment: Minimum Viable Product for Final Project</h4>

The pillbox idea has 2 main components: the actual box itself, which I'll probably 3D print, and the electronic input/output electronics. The 3D printing and Fusion designing will be pretty straightforward, so this week I decided to try out a super basic input/output circuit, since I anticipate the Arduino programming to be the most challenging part of this project.<br>
<h6><em>Outputs</em></h6>

I started with an Arduino-based circut on the breadboard to control 7 LEDs (one for each day of the week), with the idea of expanding to 14 LEDs in my later ESP32 powered iterations (I was already almost out of digital pins on the Arduino with this version). The lights would turn on according to the frequency defined in the input.<br>

<h6><em>Inputs</em></h6>
I'm starting very small with just 3 options for dose frequencies: everyday, every other day, and twice a week. Each option has a corresponding button. I don't think the final version will be button-based for input because it really limits the type of prescription regimens that you can input into the device, so Kassia suggested I try FireBase to store information about the user's exisitng regimens, allowing greater input options. To test that I could actually do the coding to make sure the lights turned on in multiple different ways, I stuck with the buttons for now. I added another button to reset/turn off the lights when the user is done filling one prescription. Eventually I want to use the capacitive pressure sensor or photoresistor inside each compartment to sense when pills are put in it and turn off the LED, but I'm still troubleshooting that and working on how to make the capacitive sensor sensitive enough.
<p class="margin">   </p>
<h6><em>Circuit and Code</em></h6>
Here is the circuit as I built it, and a TinkerCad illustration to clearly show the connections:
<p class="margin">   </p>
<div class="flexrow">
  <img src="./breadboard.jpeg" alt="breadboard with 7 LEDs and 4 buttons connected to an Arduino" width="45%">
  <img src="./tinkercadss.png" alt="illustration of breadboard with 7 LEDs and 4 buttons connected to an Arduino" width="45%">
</div>
  <br>

And here is the annotated code I came to after much troubleshooting and learning about toggle and i in Arduino.


<pre><code>
// making a pillbox class
class Pillbox {
  private:
    const int* ledPins; // Pointer to an array of LED pins
    bool* ledState; // Pointer to an array of LED states
    unsigned long previousMillis; // Variable storing previous time
    const long interval; // Interval for LED toggle (1 second)

  public:
    Pillbox(const int* pins, bool* states, long interval) 
      : ledPins(pins), ledState(states), interval(interval) {
    }

    void setup() {
      for (int i = 0; i < 7; i++) {
        pinMode(ledPins[i], OUTPUT);
        digitalWrite(ledPins[i], LOW); // turn off all LEDs on start up
      }
      previousMillis = 0; // initialize previousMillis
    }

    void toggleLEDs(int frequency) {
      unsigned long currentMillis = millis(); // get current time
      if (currentMillis - previousMillis >= interval) {
        previousMillis = currentMillis; // store last time the LEDs were toggled

        // toggle LED state for the selected day frequency
        for (int i = 0; i < 7; i++) {
          if ((i % frequency) == 0) {
            ledState[i] = !ledState[i]; // toggle LED state
            digitalWrite(ledPins[i], ledState[i] ? HIGH : LOW); // turn LED on or off
          }
        }
      }
    }

    void toggleTwiceAWeekLEDs() {
      unsigned long currentMillis = millis(); // Get the current time
      if (currentMillis - previousMillis >= interval) {
        previousMillis = currentMillis; // store last time LEDs were toggled

        // specify twice per week LEDs
        ledState[0] = !ledState[0]; // sunday LED
        ledState[3] = !ledState[3]; // wednesday LED

        // Turn on or off the LEDs for twice a week regimen
        digitalWrite(ledPins[0], ledState[0] ? HIGH : LOW); // Monday LED
        digitalWrite(ledPins[3], ledState[3] ? HIGH : LOW); // Thursday LED
      }
    }

    void turnOffLEDs() {
      for (int i = 0; i < 7; i++) {
        digitalWrite(ledPins[i], LOW); // Turn off all LEDs
        ledState[i] = false; // Reset LED state
      }
    }
};

const int ledPins[] = {2, 3, 4, 5, 6, 7, 8}; // LED pins
bool ledState[7] = {false}; // array to track LED state for each compartment

Pillbox pillbox(ledPins, ledState, 1000); // Create an instance of the Pillbox class

const int buttonEverydayPin = 9; // Pin connected to the everyday button
const int buttonEveryOtherDayPin = 10; // Pin connected to the every other day button
const int buttonTwiceAWeekPin = 11; // Pin connected to the twice a week button
const int buttonTurnOffPin = 12; // Pin connected to the button to turn off lights

void setup() {
  pinMode(buttonEverydayPin, INPUT_PULLUP); // Set the button pins as input with internal pull-up resistors
  pinMode(buttonEveryOtherDayPin, INPUT_PULLUP);
  pinMode(buttonTwiceAWeekPin, INPUT_PULLUP);
  pinMode(buttonTurnOffPin, INPUT_PULLUP);

  pillbox.setup(); // Initialize the pillbox
}

void loop() {
  // Check if everyday button is pressed
  if (digitalRead(buttonEverydayPin) == LOW) {
    pillbox.toggleLEDs(1); // Toggle LEDs for everyday button

  // Check if every other day button is pressed
  if (digitalRead(buttonEveryOtherDayPin) == LOW) {
    pillbox.toggleLEDs(2); // Toggle LEDs for every other day button
  
  }

  // Check if twice a week button is pressed
  if (digitalRead(buttonTwiceAWeekPin) == LOW) {
    pillbox.toggleTwiceAWeekLEDs(); // Toggle LEDs for twice a week button
  }

  // check if off/reset button is pressed
  if (digitalRead(buttonTurnOffPin) == LOW) {
    pillbox.turnOffLEDs(); // turn off all LEDs
  }
}
</code></pre>

It worked! Here's a live demo:<br>
<div class="flexrow">
<video width="50%" autoplay muted>
  <source src="mvpv1.MOV" type="video/mp4">
  </video>
</div>

This was great except it was pretty much just some LEDs and I needed a pillbox. So I transferred everything to a protoboard along with a 7-day pillbox (that CVS made). It's starting to look and work like (a very rudimentary version) of the real thing!<br>

<div class="flexrow">
<video width="50%" autoplay muted>
  <source src="mvpv2.MOV" type="video/mp4">
  </video>
</div>

</div>
</xmp>
</body>

<script src="../strapdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" ></script>

</html>