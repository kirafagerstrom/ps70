<!DOCTYPE html>
<html lang="en">

<title>PS70: Intro to Digital Fabrication </title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="../style.css" rel="stylesheet">


<nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #FFFFFF; color: #053034;">
  <div style="align-items: center; justify-content: center;" class="container-fluid">
    <div class="flexrow">
      <h2 class="nav-title">ps 70: intro to digital fabrication spring 24</h2>
    </div>
    <div class="navbar-nav">
      <h4><a class="nav-link" href="./index.html" style="color: #053034;">Home</a></h4>
      <h4><a class="nav-link" href="./about.html" style="color: #053034;">About</a></h4>
      <h4><a class="nav-link" href="./13_finalproject/index.html" style="color: #053034;">Final Project</a></h4>
    </div>
  </div>
</nav>

<body>
<xmp style="display:none;">
<div class="textcontainer">
<p class="margin"></p>


<h3>Final Project: Refill Guide Box</h3>
My final project is a smart pillbox that guides a user through refilling their organizer will multiple medications. <a href="https://kirafagerstrom.github.io/ps70/13_finalproject/control.html">Here is the interface website</a>. See the demo video below!<br>
<br>
<div class="flexrow">
<iframe width="560" height="315" src="https://www.youtube.com/embed/dK8TZLud9Dg?si=M_L7Fx3oUfBwbof_" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</div>

<h4>The code</h4><br>
The final version of the ESP32 code is updated from my last iteration to handle specific days of the week selected by the user, and my updated html code reflects that change.
<iframe src="https://app.arduino.cc/sketches/f3b4633f-443a-4676-ae7d-b490b6fb9e19?view-mode=embed" style="height:510px;width:100%;margin:10px 0" frameborder=0 /></iframe><br>


HTML code:
<pre><code>
&lt;html class=&quot;no-js&quot; lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
    &lt;title&gt;PHYSCI 70: Introduction to Digital Fabrication&lt;/title&gt;
    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;
    &lt;link href=&quot;../style.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;p class=&quot;margin&quot;&gt;&lt;/p&gt;&lt;br&gt;
    &lt;b&gt;&lt;h2&gt;&lt;center&gt;Welcome to Refill Guide!&lt;/center&gt;&lt;/h2&gt;&lt;/b&gt;
    &lt;div class=&quot;textcontainer&quot;&gt;
        &lt;p class=&quot;margin&quot;&gt;&lt;/p&gt;
        &lt;center&gt;&lt;b&gt;&lt;u&gt;Instructions:&lt;/u&gt;&lt;/b&gt; Fill in the information from the label on your medication bottle below. You can choose the days of the week and how many times per day you want to take it, then press &lt;b&gt;&lt;u&gt;Submit&lt;/u&gt;&lt;/b&gt;. Put the indicated amount of pills in the compartments that light up. When you're ready to refill your next prescription, press &lt;b&gt;&lt;u&gt;Next Medication&lt;/u&gt;&lt;/b&gt;, and the lights will turn off.&lt;/center&gt;
    &lt;/div&gt;
    &lt;div class=&quot;textcontainer&quot;&gt;
        &lt;label for=&quot;fname&quot;&gt;Medication Name&lt;/label&gt;&lt;br&gt;
        &lt;input type=&quot;text&quot; id=&quot;fname&quot; name=&quot;fname&quot;&gt;&lt;br&gt;&lt;br&gt;
        &lt;label for=&quot;tablets&quot;&gt;Number of Tablets&lt;/label&gt;&lt;br&gt;
        &lt;input type=&quot;number&quot; id=&quot;tablets&quot; name=&quot;tablets&quot;&gt;&lt;br&gt;&lt;br&gt;
        &lt;label for=&quot;radio&quot;&gt;Medication Frequency: How many times per &lt;b&gt;week&lt;/b&gt; do you take it?&lt;/label&gt;&lt;br&gt;
        &lt;input type=&quot;radio&quot; id=&quot;everyday&quot; name=&quot;frequency&quot; value=&quot;1&quot;&gt;
        &lt;label for=&quot;html&quot;&gt;Daily/everyday&lt;/label&gt;&lt;br&gt;
        &lt;input type=&quot;radio&quot; id=&quot;everyotherday&quot; name=&quot;frequency&quot; value=&quot;2&quot;&gt;
        &lt;label for=&quot;html&quot;&gt;Every other day&lt;/label&gt;&lt;br&gt;
        &lt;input type=&quot;radio&quot; id=&quot;twice&quot; name=&quot;frequency&quot; value=&quot;3&quot;&gt;
        &lt;label for=&quot;html&quot;&gt;Twice per week&lt;/label&gt;&lt;br&gt;
        &lt;input type=&quot;radio&quot; id=&quot;threetimes&quot; name=&quot;frequency&quot; value=&quot;4&quot;&gt;
        &lt;label for=&quot;html&quot;&gt;Three times per week&lt;/label&gt;&lt;br&gt;
        &lt;input type=&quot;radio&quot; id=&quot;fourtimes&quot; name=&quot;frequency&quot; value=&quot;5&quot;&gt;
        &lt;label for=&quot;html&quot;&gt;Four times per week&lt;/label&gt;&lt;br&gt;
        &lt;input type=&quot;radio&quot; id=&quot;fivetimes&quot; name=&quot;frequency&quot; value=&quot;6&quot;&gt;
        &lt;label for=&quot;html&quot;&gt;Five times per week&lt;/label&gt;&lt;br&gt;
        
        &lt;div id=&quot;daySelection&quot; style=&quot;display: none;&quot;&gt;
            &lt;label for=&quot;days&quot;&gt;Select days:&lt;/label&gt;&lt;br&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;sunday&quot; name=&quot;days&quot; value=&quot;Sunday&quot;&gt;
            &lt;label for=&quot;sunday&quot;&gt;Sunday&lt;/label&gt;&lt;br&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;monday&quot; name=&quot;days&quot; value=&quot;Monday&quot;&gt;
            &lt;label for=&quot;monday&quot;&gt;Monday&lt;/label&gt;&lt;br&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;tuesday&quot; name=&quot;days&quot; value=&quot;Tuesday&quot;&gt;
            &lt;label for=&quot;tuesday&quot;&gt;Tuesday&lt;/label&gt;&lt;br&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;wednesday&quot; name=&quot;days&quot; value=&quot;Wednesday&quot;&gt;
            &lt;label for=&quot;wednesday&quot;&gt;Wednesday&lt;/label&gt;&lt;br&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;thursday&quot; name=&quot;days&quot; value=&quot;Thursday&quot;&gt;
            &lt;label for=&quot;thursday&quot;&gt;Thursday&lt;/label&gt;&lt;br&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;friday&quot; name=&quot;days&quot; value=&quot;Friday&quot;&gt;
            &lt;label for=&quot;friday&quot;&gt;Friday&lt;/label&gt;&lt;br&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;saturday&quot; name=&quot;days&quot; value=&quot;Saturday&quot;&gt;
            &lt;label for=&quot;saturday&quot;&gt;Saturday&lt;/label&gt;&lt;br&gt;
        &lt;/div&gt;
&lt;script&gt;
    document.querySelectorAll(&#39;input[name=&quot;frequency&quot;]&#39;).forEach(function(radio) {
        radio.addEventListener(&#39;change&#39;, function() {
            if (this.value === &#39;3&#39; || this.value === &#39;4&#39; || this.value === &#39;5&#39; || this.value === &#39;6&#39;) {
                // If frequency is three, four, or five times per week
                document.getElementById(&#39;daySelection&#39;).style.display = &#39;block&#39;;
            } else {
                document.getElementById(&#39;daySelection&#39;).style.display = &#39;none&#39;;
            }
        });
    });
&lt;/script&gt;

        &lt;br&gt;
        &lt;label for=&quot;radio&quot;&gt;Medication Frequency: How many times per &lt;b&gt;day&lt;/b&gt; do you take it?&lt;/label&gt;&lt;br&gt;
        &lt;input type=&quot;radio&quot; id=&quot;onceday&quot; name=&quot;dayfrequency&quot; value=&quot;onceday&quot;&gt;
        &lt;label for=&quot;html&quot;&gt;Once&lt;/label&gt;&lt;br&gt;
        &lt;input type=&quot;radio&quot; id=&quot;twiceeday&quot; name=&quot;dayfrequency&quot; value=&quot;twiceday&quot;&gt;
        &lt;label for=&quot;html&quot;&gt;Twice&lt;/label&gt;&lt;br&gt;
        &lt;br&gt;
        &lt;button id=&quot;submit&quot;&gt;Submit&lt;/button&gt;&lt;br&gt;&lt;br&gt;
            &lt;div id=&quot;summarySection&quot; style=&quot;display: none;&quot;&gt;
        &lt;h3&gt;You're filling:&lt;/h3&gt;
        &lt;p id=&quot;summary&quot;&gt;&lt;/p&gt;
    &lt;/div&gt;
        &lt;button id=&quot;next&quot;&gt;Next Medication&lt;/button&gt;&lt;br&gt;&lt;br&gt;
    &lt;/div&gt;
    &lt;!-- Section to display summary --&gt;


    &lt;!-- The core Firebase JS SDK is always required and must be listed first --&gt;
    &lt;script src=&quot;https://www.gstatic.com/firebasejs/7.13.2/firebase-app.js&quot;&gt;&lt;/script&gt;

    &lt;!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries --&gt;
    &lt;script src=&quot;https://www.gstatic.com/firebasejs/7.13.2/firebase-database.js&quot;&gt;&lt;/script&gt;

    &lt;script&gt;
        // Your web app's Firebase configuration
    var firebaseConfig = {
        apiKey: &quot;api key&quot;,
        authDomain: &quot;authdomain&quot;,
        databaseURL: &quot;https://smart-pillbox-87589-default-rtdb.firebaseio.com&quot;,
        projectId: &quot;smart-pillbox-87589&quot;,
        storageBucket: &quot;smart-pillbox-87589.appspot.com&quot;,
        messagingSenderId: &quot;146779684231&quot;,
        appId: &quot;1:146779684231:web:2799f82347dc5cec10e722&quot;,
        measurementId: &quot;G-4T82GV1Q19&quot;
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Get a database reference to our blog
        var ref = firebase.database().ref(&quot;/&quot;);

        // Function to send medication data to Firebase
        function submit() {
    var medicationName = document.getElementById(&#39;fname&#39;).value;
    var weekFrequency = parseInt(document.querySelector(&#39;input[name=&quot;frequency&quot;]:checked&#39;).value);
    var dayFrequency = document.querySelector(&#39;input[name=&quot;dayfrequency&quot;]:checked&#39;).value;
    var tabletCount = document.getElementById(&#39;tablets&#39;).value;

    var frequencyText;
    // Update frequencyText based on weekFrequency value
    switch (weekFrequency) {
        case 1:
            frequencyText = &#39;everyday&#39;; // Change to &#39;daily&#39; if preferred
            break;
        case 2:
            frequencyText = &#39;every other day&#39;;
            break;
        case 3:
            frequencyText = &#39;twice per week&#39;;
            break;
        case 4:
            frequencyText = &#39;three times per week&#39;;
            break;
        case 5:
            frequencyText = &#39;four times per week&#39;;
            break;
        case 6:
            frequencyText = &#39;five times per week&#39;;
            break;
        default:
            frequencyText = weekFrequency + &#39; times per week&#39;;
    }

    var dayFrequencyText;
    // Update dayFrequencyText based on dayFrequency value
    switch (dayFrequency) {
        case &#39;onceday&#39;:
            dayFrequencyText = &#39;once&#39;;
            break;
        case &#39;twiceday&#39;:
            dayFrequencyText = &#39;twice&#39;;
            break;
        default:
            dayFrequencyText = dayFrequency;
    }

    var daysSelected = [];
    if (weekFrequency &gt;= 3 && weekFrequency &lt;= 6) {
        // Get the selected days
        var selectedDays = document.querySelectorAll(&#39;input[name=&quot;days&quot;]&#39;);
        selectedDays.forEach(function(day) {
            if (day.checked) {
                daysSelected.push(day.value);
            }
        });
    }

    var data = {
        &quot;Medication_Name&quot;: medicationName,
        &quot;Week_Frequency&quot;: {
            &quot;value&quot;: weekFrequency,
            &quot;days&quot;: daysSelected
        },
        &quot;Day_Frequency&quot;: dayFrequency,
        &quot;Turn_Off_LEDs&quot;: false,
        &quot;Tablet_Count&quot;: tabletCount
    };

    ref.update(data);

    // Display summary on the same page
    var summarySentence = medicationName + &quot;, &quot; + frequencyText + &quot;, &quot; + dayFrequencyText + &quot; per day. Put &quot; + tabletCount + &quot; tablets in the lighted compartments, then press Next Medication to move on.&quot;;
    var summaryHTML = &quot;&lt;h3&gt;&quot; + summarySentence + &quot;&lt;/h3&gt;&quot;;
    document.getElementById(&#39;summary&#39;).innerHTML = summaryHTML;
    document.getElementById(&#39;summarySection&#39;).style.display = &#39;block&#39;;
}

        // Function for next medication
        function next() {
            // Clear input fields
            document.getElementById(&#39;fname&#39;).value = &#39;&#39;; // Medication Name
            document.getElementById(&#39;tablets&#39;).value = &#39;&#39;; // Tablet Count

            // Clear radio button selections for medication frequency (week)
            var weekFrequencyRadios = document.querySelectorAll(&#39;input[name=&quot;frequency&quot;]&#39;);
            weekFrequencyRadios.forEach(function(radio) {
                radio.checked = false;
            });

            // Clear radio button selections for medication frequency (day)
            var dayFrequencyRadios = document.querySelectorAll(&#39;input[name=&quot;dayfrequency&quot;]&#39;);
            dayFrequencyRadios.forEach(function(radio) {
                radio.checked = false;
            });

            // Clear radio button selections for time of day
            var timeDayRadios = document.querySelectorAll(&#39;input[name=&quot;timeday&quot;]&#39;);
            timeDayRadios.forEach(function(radio) {
                radio.checked = false;
            });
                // Clear the summary content
    document.getElementById(&#39;summary&#39;).textContent = &#39;&#39;;

    // Hide summary section
    document.getElementById(&#39;summarySection&#39;).style.display = &#39;none&#39;;

            // Send signal to Firebase to turn off LEDs
            ref.update({
                &quot;Turn_Off_LEDs&quot;: true,
                &quot;Week_Frequency&quot;: null, // Clear Week_Frequency field in Firebase
                &quot;Day_Frequency&quot;: null, // Clear Day_Frequency field in Firebase
                &quot;Medication_Name&quot;: null, // Clear Medication_name field in Firebase
                &quot;Time_Day&quot;: null // Clear Time_Day field in Firebase
            });

            // Hide summary section
            document.getElementById(&#39;summarySection&#39;).style.display = &#39;none&#39;;
        }

        // Attach event listeners to the buttons
        document.getElementById(&#39;submit&#39;).addEventListener(&#39;click&#39;, submit, false);
        document.getElementById(&#39;next&#39;).addEventListener(&#39;click&#39;, next, false);

    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><br>
<h4>Assembly</h4><br>
The box is made of 4 3D printed components. <a href="./final box v6.stl" download>Download the printable file here</a>.<br>
<div class="flexrow">
<video width="50%" autoplay muted>
  <source src="./opening box.MOV" type="video/mp4">
  </video>
</div>


<b>The lid</b>:<br>
<div class="flexrow">
  <img src="./lid cad.png" alt="cad model of a box lid" width="35%">
</div>

The lid has a snapfit lock at the front to close the box, and has hinge components at the back. I used a wire as the pin to connect the lid hinge with the box hinge. 

<b>The box:</b><br>
<div class="flexrow">
  <img src="./middle box.png" alt="cad model of a box lid" width="35%">
</div>

The box press fits into the base, and has morning and night compartments for each day, which are labeled as insets in the box. Each compartment has a hole where the LED sits.<br>

<b>The base/slider lid</b>:<br>
<div class="flexrow">
  <img src="./ base.png" alt="cad model of a box lid" width="35%">
  <img src="./slider.gif" alt="gif of sliding lid" width="35%">
</div>

The base press and snap fits into the compartment component, and is an empty space to hold electronic components, with openings under each LED to feed the LED wires into the base. Underneath, it has a slider lid to close the base when wiring is done. <br>
<b>Wiring:</b><br>
Each LED is connected to an ESP32 pin through its positive leg, and a 100K resisistor through the shorter leg, which goes to ground. Pins 13, 14, 27, 26, 25, 33, 32 are connected to the morning row of LEDs, and pins 15, 4, 18, 19, 21, 22, 23 are connected to the evening row of LEDs (the order of the array corresponds to the day of the week, so 13 is Sunday, 14 is Monday and so on). The LED legs are threaded through the holes in the base, and all the connections are made inside the base enclosure. The system is currently powered with my laptop, with battery integration as a potential next step.<br>
<div class="flexrow">
  <img src="./total wiring.jpeg" alt="wiring of circuit within box" width="35%">
  <img src="./open box.jpeg" alt="open box with LEDs" width="35%" height="35%">
</div>
<br>

<h4>Read below for updates from throughout the process, with notes on next steps throughout:</h4><br>
<h3 style="color:#e2165b";>Part One: Deciding on an idea</h3>
I decided to go with the Smart Pill Box idea to guide the user when filling their medication organizer. Here's the description from Week One again: <br>
A lot of smart pillboxes focus on reminding the user when to take their medications. My idea aims to make the other end of medication administration, filling the pillbox, easier. The idea is inspired by a couple of friends and relatives with chronic illnesses whose prescriptions change from month to month, making their medication schedules pretty complicated. 

<br>
<br>

<h5><em><b>How it works</b></em></h5>
The organizer would look like a standard seven-day box, with each day divided into morning and night. It would sit on a base that puts lights under each compartment. At the beginning of each week, the user would input the instructions on the original bottle's label like "take 2 capsules every other day in the morning", either using buttons on the box or an interface on a computer/phone (maybe a website?). The corresponding compartments would light up based on the given schedule. Future iterations could include a reminder feature or an indication of how many pills to put in each compartment (i.e. the <a href="https://elliegrid.com/products/ellie-smart-pill-box">Ellie Grid</a>).<br>
<br>

<h3 style="color:#e2165b";>Part Two: Designing a box</h3>

<h4><b>CAD model</b></h4>
The first model I've made recapitulates a classic medication organizer design with 2 rows of 7 compartments for each day. Each compartment is a 3x3x3 snap-fit box that opens with a hinge. <br>
<div class="flexrow">
  <img src="./first model.png" alt="cad model of a 14 dose pillbox" width="35%">
</div>
<p>
I'm not exactly sure how the electronic components will work or how they'll fit on the board, but I'm envisioning an LED either on the lid or on the outer edge of each box that turns on to indicate that a medication dose belongs in that box. <a href="./full box v2.stl" download>Here is the STL file of the design</a>.
<br>
<br>
<h4><b>Materials</b></h4>
PRUSA printer/filament<br>
Arduino<br>
PCB/protoboard<br>
LEDs<br>
Wires/connectors/resistors/circuit elements<br>
Web server<br>
<br>

<h4><b>Timeline</b></h4>
<b>After wifi/bluetooth week:</b> Design input system (~1-2 weeks)<br>
Based on input system and circuitry, adjust CAD of box (~ 1 week)<br>
Print box and assemble circuitry(~ 1 week)<br>
<a href="cnc.stl" download>Example CNC file for day labels on pillbox!</a>
<br>
<br>


<h3 style="color:#e2165b";>Part Three: Building a prototype</h3>
<h4>Minimum Viable Product</h4>

The pillbox idea has 2 main components: the actual box itself, which I'll probably 3D print, and the electronic input/output electronics. The 3D printing and Fusion designing will be pretty straightforward, so this week I decided to try out a super basic input/output circuit, since I anticipate the Arduino programming to be the most challenging part of this project.<br>
<br>
<h6><em>outputs</em></h6>

I started with an Arduino-based circut on the breadboard to control 7 LEDs (one for each day of the week), with the idea of expanding to 14 LEDs in my later ESP32 powered iterations (I was already almost out of digital pins on the Arduino with this version). The lights would turn on according to the frequency defined in the input.<br>
<br>
<h6><em>inputs</em></h6>
I'm starting very small with just 3 options for dose frequencies: everyday, every other day, and twice a week. Each option has a corresponding button. I don't think the final version will be button-based for input because it really limits the type of prescription regimens that you can input into the device, so Kassia suggested I try FireBase to store information about the user's exisitng regimens, allowing greater input options. To test that I could actually do the coding to make sure the lights turned on in multiple different ways, I stuck with the buttons for now. I added another button to reset/turn off the lights when the user is done filling one prescription. Eventually I want to use the capacitive pressure sensor or photoresistor inside each compartment to sense when pills are put in it and turn off the LED, but I'm still troubleshooting that and working on how to make the capacitive sensor sensitive enough.
<p class="margin">   </p>
<h6><em>Circuit and Code</em></h6>
Here is the circuit as I built it, and a TinkerCad illustration to clearly show the connections (resistors are 10 kOhms):
<p class="margin">   </p>
<div class="flexrow">
  <img src="/Users/kirafagerstrom/Documents/GitHub/ps70/07_outputs/breadboard.jpeg" alt="breadboard with 7 LEDs and 4 buttons connected to an Arduino" width="45%">
  <img src="/Users/kirafagerstrom/Documents/GitHub/ps70/07_outputs/tinkercadss.png" alt="illustration of breadboard with 7 LEDs and 4 buttons connected to an Arduino" width="45%">
</div>
  <br>

And here is the annotated code I came to after much troubleshooting and learning about toggle and i in Arduino, and some chatgpt debugging help. Learning Arduino code is a highly recommended spring break activity. <br>
Some helpful sources: <a href="https://www.arduino.cc/reference/en/libraries/toggle/">Arduino toggle library</a>, <a href="https://forum.arduino.cc/t/use-a-push-button-as-a-toggle-switch/486589">Arduino forum</a>, <a href="https://forum.arduino.cc/t/how-to-toggle-led/508015/5">this Arduino forum</a>, <a href="https://forum.arduino.cc/t/creating-class-and-objects/997333">and the class and objects forum on Arduino</a>.

<iframe src=https://create.arduino.cc/editor/kfagerstrom/5158ec5c-90a0-4386-a4ba-6850a54af3fe/preview?embed style="height:510px;width:100%;margin:10px 0" frameborder=0></iframe>

It worked! Here's a live demo:<br>
<div class="flexrow">
<video width="50%" autoplay muted>
  <source src="/Users/kirafagerstrom/Documents/GitHub/ps70/07_outputs/mvpv1.MOV" type="video/mp4">
  </video>
</div>

This was great except it was pretty much just some LEDs and I needed a pillbox. So I transferred everything to a protoboard along with a 7-day pillbox (that CVS made). It's starting to look and work like (a very rudimentary version) of the real thing!<br>

<div class="flexrow">
<video width="50%" autoplay muted>
  <source src="/Users/kirafagerstrom/Documents/GitHub/ps70/07_outputs/mvpv2.MOV" type="video/mp4">
  </video>
</div>

It was super helpful to put everything on the protoboard so I can have an idea of how to design the box around the electronics in Fusion. 

<h6><em>the vision</em></h6>
The vision is coming together, but there are many next steps to be taken. Next week for Wifi and Bluetooth I'll work on the advanced input versions, and I already found a couple tutorials on using an html website to control an Arduino. After or simultaneously with putting that together, I'll try integrating the ESP32 because I'll definitely need more than the Arduino's 13 digital pins. Using the capacitive sensor to sense pill presence seems like it will be the last part because it goes a little bit beyond the basic functionality of the pillbox. But the vision is always changing so we'll see what I'm thinking next week.

<h6><em>oscilloscope</em></h6>
The oscilloscope readings turned out to be very boring when I hooked it up the LEDs and buttons because all they were doing was turning on and off. But i got a reading of the on and off voltages shown below, and it was cool to zoom in on the wave at the exact moment of turning on and off:
<div class="flexrow">
<video width="50%" autoplay muted>
  <source src="/Users/kirafagerstrom/Documents/GitHub/ps70/07_outputs/oscilloscope.MOV" type="video/mp4">
  </video>
</div>

<p class="margin">   </p>
<div class="flexrow">
  <img src="/Users/kirafagerstrom/Documents/GitHub/ps70/07_outputs/oscilloscope.jpeg" alt="picture of oscilloscope reading voltage" width="45%">
</div>
<p class="caption">oscilloscope reading at the moment the button was turned on, with the off voltage jumping up to the on voltage</p>
I think this will be much more informative with the capacitive sensor/pill sensors because the circuit will have a lot more complexity. And the variable input may have a cooler wave function.

<h3 style="color:#e2165b";>Part Four: Iterating</h3>

<h5>Iteration 2</h5>
This iteration, I replaced the physical input buttons with a website interface, giving the user a few more options and ability to choose the frequency within a day. I used the same strategy as the machine building and networking assignments to connect the website interface to a Firebase RTDB, which relayed commands to the ESP32, turning on the LEDs according to the inputted regimen. I used the same basic tutorials from networking week (from <a href="https://randomnerdtutorials.com/esp32-firebase-realtime-database/">RandomNerd</a> and <a href="https://nathanmelenbrink.github.io/ps70/09_networking/index.html">Nathan</a>). <a href="https://kirafagerstrom.github.io/ps70/13_finalproject/control.html">Here is the control interface website</a>, and below is a screenshot of the Firebase RTDB updating according to the website:<br>
<p class="margin">   </p>
<div class="flexrow">
  <img src="./control1.png" width="30%">
  <img src="./firebasess.png" width="55%">
</div><br>
<br>
Here's the updated wiring to the ESP32, where each LED is connected to D13, 14, 27, 26, 25, 35, which on the Dev Board have both input and output capability:<br>
<p class="margin">   </p>
<div class="flexrow">
  <img src="./wiring.jpeg" alt="circuit with a pillbox and lights" width="45%">
</div>

Here is the ESP code, which I had some trouble with at first, but switched the class structures back to normal functions for easier decoding, and came up with this working code. I then expanded this to control 2 rows of LEDs, one for the morning compartments and one for the evening, and updated my html code for the control website to match this functionality. All 3 codes are below:
<br>
<b>Single Row Code</b>
<br>
<center><div style="code-box;overflow:auto;">
  <pre><code>
                //code for connecting to firebase/controls
            //control website: <a href="https://kirafagerstrom.github.io/ps70/13_finalproject/control.html">https://kirafagerstrom.github.io/ps70/13_finalproject/control.html</a>

            #include &lt;Arduino.h&gt;
            #if defined(ESP32)
              #include &lt;WiFi.h&gt;
            #elif defined(ESP8266)
              #include &lt;ESP8266WiFi.h&gt;
            #endif
            #include &lt;Firebase_ESP_Client.h&gt;


            //Provide the token generation process info.
            #include "addons/TokenHelper.h"
            //Provide the RTDB payload printing info and other helper functions.
            #include "addons/RTDBHelper.h"

            // Insert your network credentials but take them out when you put them online
            #define WIFI_SSID "wifi"
            #define WIFI_PASSWORD "password"

            // Insert Firebase project API Key
            #define API_KEY "api key"

            // Insert RTDB URLefine the RTDB URL /
            #define DATABASE_URL "databaseurl.com" 

            //Define Firebase Data object
            FirebaseData fbdo;

            FirebaseAuth auth;
            FirebaseConfig config;
            bool signupOK = false;

            const int ledPins[] = {13, 14, 27, 26, 25, 33, 32}; // Pins connected to LEDs
            bool ledState[7] = {false}; // Array to track the LED state for each compartment

            unsigned long previousMillis = 0; // Variable to store the previous time
            const long interval = 1000; // Interval for LED toggle (1 second)

            void setup() {
              Serial.begin(115200);
              Serial.println("Initializing");

              // Connect to Wi-Fi
              WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
              Serial.print("Connecting to Wi-Fi");
              while (WiFi.status() != WL_CONNECTED) {
                Serial.print(".");
                delay(300);
              }
              Serial.println();
              Serial.print("Connected with IP: ");
              Serial.println(WiFi.localIP());
              Serial.println();

              // Initialize Firebase
              config.api_key = API_KEY;
              config.database_url = DATABASE_URL;
              if (Firebase.signUp(&config, &auth, "", "")) {
                Serial.println("Firebase signed up successfully");
                signupOK = true;
              } else {
                Serial.printf("Firebase signup error: %s\n", config.signer.signupError.message.c_str());
              }
              config.token_status_callback = tokenStatusCallback; //see addons/TokenHelper.h
              Firebase.begin(&config, &auth);
              Firebase.reconnectWiFi(true);

              for (int i = 0; i < 7; i++) {
                pinMode(ledPins[i], OUTPUT);
              }

            }

            void loop() {
              if (signupOK) {
                if (Firebase.RTDB.getInt(&fbdo, "/Week_Frequency")) {
                  int frequency =  fbdo.intData();
                  switch (frequency) {
                    case 1:
                      turnOnEverydayLEDs();
                      break;
                    case 2:
                      turnOnEveryOtherDayLEDs();
                      break;
                    case 3:
                      turnOnTwiceAWeekLEDs();
                      break;
                    case 4:
                      turnOnThreeTimesAWeekLEDs();
                      break;
                    case 5:
                      turnOnFourTimesAWeekLEDs();
                      break;
                    case 6:
                      turnOnFiveTimesAWeekLEDs();
                      break;
                    default:
                      turnOffAllLEDs();
                      break;
                  }
                }
              }
                if (Firebase.RTDB.getBool(&fbdo, "/Turn_Off_LEDs")) { // Check if the data is successfully retrieved from the Firebase Realtime Database for "turn_off_leds"
                  bool turnOffLEDs = fbdo.boolData(); // Get the boolean value from the Firebase data
                  if (turnOffLEDs) {
                    turnOffAllLEDs(); // If 'turn_off_leds' is true, turn off all LEDs
                  }
                }

            }

            void turnOnEverydayLEDs() {
              for (int i = 0; i < 7; i++) {
                digitalWrite(ledPins[i], HIGH);
              }
            }

            void turnOnEveryOtherDayLEDs() {
              for (int i = 0; i < 7; i += 2) {
                digitalWrite(ledPins[i], HIGH);
              }
            }

            void turnOnTwiceAWeekLEDs() {
              for (int i = 0; i < 2; i++) {
                digitalWrite(ledPins[i], HIGH);
              }
            }

            void turnOnThreeTimesAWeekLEDs() {
              for (int i = 0; i < 3; i++) {
                digitalWrite(ledPins[i], HIGH);
              }
            }

            void turnOnFourTimesAWeekLEDs() {
              for (int i = 0; i < 4; i++) {
                digitalWrite(ledPins[i], HIGH);
              }
            }

            void turnOnFiveTimesAWeekLEDs() {
              for (int i = 0; i < 5; i++) {
                digitalWrite(ledPins[i], HIGH);
              }
            }

            void turnOffAllLEDs() {
              for (int i = 0; i < 7; i++) {
                digitalWrite(ledPins[i], LOW);
              }
            }
        </pre>
    </code>
  </pre></div></center>



I came back to this code, but undid the class structure and instead used cases for each possible LED option, and updated the html code to 
<br>
<br>
<h5>Future iterations</h5>
Once I get the code working, I'll add in the capacitive sensors for each compartment (which I'll need to multiplex). The other big step will be to design and 3D print the box with room for the electronics, and integrate power.<br>
<br>

<h3 style="color:#e2165b";>Part Five: The final (?) product</h3>
The demo shows my product as it exists at the moment. I did want and try to integrate a feature to sense when pills were added to the box and thus turn the light off for the compartment, but ran out of time to complete it. Here's a summary of that process:<br>
I first tried a few different ways of capacitive sensing, effectively building my own <a href="https://www.amazon.com/Pressure-Flexible-Sensitive-Waterproof-Resistor/dp/B0B8K4KR34/ref=asc_df_B0B8K4KR34/?tag=hyprod-20&linkCode=df0&hvadid=693071814688&hvpos=&hvnetw=g&hvrand=16525620245343154892&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=9001999&hvtargid=pla-1952108706435&psc=1&mcid=8cc76ea8916731abacd3ce4597efa39f&gad_source=1&gclid=Cj0KCQjw6PGxBhCVARIsAIumnWaRNvHQaEiHC69ZmtL5GrwWj7IN5fHwQpFho7g10Q0cPRI3kEt-VFYaAt_jEALw_wcB">pressure sensor</a>. Here are the two options I tried out: 
<p class="margin">   </p>
<div class="flexrow">
  <img src="./schematic cap sense.png" width="30%">
</div><br>
<br>

For both, I  used the tx-rx setup and circuit on the class website from input week, trying out a variety of resistors to adjust sensitivity (from 100 kOhms to 10 MOhms). However, like many others experience in input week, capacitive sensing for things that aren't super conductive, like a small pill, is unreliable and has a lot of drift in the signal. I couldn't achieve a consistent reading, or a threshold for when the  box had pills in it and the light should turn off. From this I mostly learned that capacitive sensing is best used for sensing when you touch or go near a surface, but is less useful for inanimate and small objects. Maybe a really big pill would work?<br>

<p class="margin">   </p>
<div class="flexrow">
  <img src="./cap sense.jpeg" width="30%">
  <img src="./cap sense 2.jpeg" width="30%">
</div><br>
<br>
<p class="caption">The setups for the two different types of capacitive sensing I tried</p>

Next I tried piezo sensing, where the idea was to attach a piezo plate to the bottom of each compartment in my pillbox, which would sense when the box experienced a vibration (i.e. when someone puts tablets into it), and turn off the light in the compartment that it sensed vibration in. Testing out this idea (see <a href="https://kirafagerstrom.github.io/ps70/06_inputs/index.html")>my updated input week assignment</a>) was actually more promising than the capacitive sensor as it was more reliable, with less drift and a more consistent reading for when I put pills in the respective box. As I was working on this, I ran out of time to integrate it into the full final project, but would love to continue optimizing this strategy if I were to continue with the project! As of now, the function to turn off the LEDs is up to the user pressing "Next Medication" on the control website, which might actually be the most reliable (but boring) option of them all.

</div>
</xmp>
</body>

<script src="../strapdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" ></script>

</html>